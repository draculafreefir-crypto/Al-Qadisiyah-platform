<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{ --g:#006C35; --gl:#00A352; --gd:#004d26; }
*{ margin:0; padding:0; box-sizing:border-box; }
html{ scroll-behavior:smooth; }
body{ font-family:'IBM Plex Sans Arabic','Segoe UI',sans-serif; overflow-x:hidden; min-height:100vh; }
input, textarea{ font-family:inherit; }
/* Responsive images */
img{ max-width:100%; height:auto; display:block; }
/* Prevent zoom on input focus (iOS) */
@media screen and (max-width: 768px) {
    input[type="text"], input[type="password"], textarea, select{ font-size:16px !important; }
}
@keyframes slideUp{ from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
@keyframes msgIn{ from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
@keyframes spin{ to{transform:rotate(360deg)} }
.slide-up{ animation:slideUp .4s ease-out forwards; opacity:0; }
.fade-in{ animation:fadeIn .3s ease-out forwards; opacity:0; }
.msg-in{ animation:msgIn .25s ease-out; }
.spin{ animation:spin .8s linear infinite; }
::-webkit-scrollbar{ width:5px; }
::-webkit-scrollbar-thumb{ background:#94a3b8; border-radius:3px; }
.bubble-user{ background:linear-gradient(135deg,var(--g),var(--gl)); }
.bubble-ai{ background:#fff; border:1px solid #e2e8f0; }
.progress-track{ background:#e2e8f0; border-radius:999px; overflow:hidden; }
.progress-fill{ height:100%; border-radius:999px; background:linear-gradient(90deg,var(--g),var(--gl)); transition:width .5s ease; }
.chart-bar{ background:linear-gradient(180deg,var(--gl),var(--g)); border-radius:6px 6px 0 0; transition:height .5s ease; }
.gpa-ring{ position:relative; width:130px; height:130px; }
.gpa-ring svg{ transform:rotate(-90deg); }
.gpa-ring .val{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; }
/* timetable grid */
.timetable{ border:2px solid #cbd5e1; width:100%; }
.timetable th{ background:linear-gradient(135deg,var(--gd),var(--g)); color:#fff; padding:12px 8px; font-size:.8rem; text-align:center; font-weight:700; border:1px solid #94a3b8; }
.timetable td{ border:1px solid #cbd5e1; padding:10px 6px; font-size:.75rem; text-align:center; min-height:60px; vertical-align:middle; background:#fff; }
.timetable td:first-child{ background:linear-gradient(135deg,#f8fafc,#e2e8f0); font-weight:700; color:var(--gd); font-size:.85rem; border-left:3px solid var(--g); }
.timetable tbody tr:hover td{ background:#f0fdf4; }
.cell-lesson{ background:linear-gradient(135deg,#d1fae5,#a7f3d0); border-radius:8px; padding:6px 8px; font-size:.75rem; color:#065f46; font-weight:700; border:1px solid #6ee7b7; box-shadow:0 1px 2px rgba(0,0,0,0.05); }

/* ============ MOBILE & TABLET RESPONSIVE ============ */

/* Large Desktop (min-width: 1920px) - 4K/Ultra-wide screens */
@media (min-width: 1920px) {
    body{ font-size:18px; }
    .text-2xl{ font-size:2rem !important; }
    .text-xl{ font-size:1.5rem !important; }
    .max-w-5xl{ max-width:80rem !important; }
    .max-w-6xl{ max-width:90rem !important; }
    .grid.grid-cols-3{ grid-template-columns:repeat(4,1fr); }
    .timetable th, .timetable td{ padding:14px 10px; font-size:.9rem; }
    .cell-lesson{ font-size:.85rem; padding:8px 10px; }
}

/* Desktop (1280px - 1920px) - Standard desktop */
@media (min-width: 1280px) and (max-width: 1919px) {
    body{ font-size:16px; }
    .max-w-5xl{ max-width:72rem; }
    .max-w-6xl{ max-width:80rem; }
}

/* Tablets (768px - 1024px) */
@media (max-width: 1024px) and (min-width: 769px) {
    body{ font-size:15px; }
    .timetable th, .timetable td{ padding:8px 4px; font-size:.7rem; }
    .cell-lesson{ font-size:.65rem; padding:4px 6px; }
    .gpa-ring{ width:110px; height:110px; }
    
    /* Adjust grid layouts for tablets - 2 columns */
    .grid.grid-cols-3{ grid-template-columns:repeat(2,1fr) !important; }
    .grid.grid-cols-4{ grid-template-columns:repeat(2,1fr) !important; }
    .grid.lg\\:grid-cols-3{ grid-template-columns:repeat(2,1fr) !important; }
    
    /* Better spacing on tablets */
    .p-6{ padding:1.25rem; }
    .gap-4{ gap:1rem; }
}

/* Mobile (max-width: 768px) */
@media (max-width: 768px) {
    /* Hide scrollbar on mobile for cleaner look */
    ::-webkit-scrollbar{ width:0px; }
    
    /* Body and container adjustments */
    body{ font-size:14px; }
    
    /* Sidebar - auto-close on mobile by default */
    .w-80, .w-72{ width:60px !important; }
    
    /* Full width containers on mobile */
    .max-w-3xl, .max-w-4xl, .max-w-5xl, .max-w-6xl{ max-width:100% !important; padding:0 1rem; }
    
    /* Stack all grids on mobile */
    .grid{ grid-template-columns:1fr !important; }
    
    /* Timetable - smaller and scrollable on mobile */
    .timetable{ font-size:.55rem; display:block; overflow-x:auto; }
    .timetable th, .timetable td{ padding:6px 3px; font-size:.6rem; white-space:nowrap; }
    .cell-lesson{ font-size:.55rem; padding:3px 4px; }
    
    /* Smaller rings and stats */
    .gpa-ring{ width:90px; height:90px; }
    
    /* Adjust spacing for mobile */
    .p-6{ padding:1rem !important; }
    .p-5{ padding:0.875rem !important; }
    .p-4{ padding:0.75rem !important; }
    .space-y-5>*+*{ margin-top:1rem !important; }
    .space-y-4>*+*{ margin-top:0.875rem !important; }
    .gap-4{ gap:0.75rem !important; }
    
    /* Text sizes */
    .text-2xl{ font-size:1.4rem !important; }
    .text-xl{ font-size:1.15rem !important; }
    .text-lg{ font-size:1rem !important; }
    
    /* Buttons - make them easier to tap */
    button{ min-height:44px; }
    
    /* Chat bubbles - better mobile width */
    .max-w-\[70\%\]{ max-width:85% !important; }
    .max-w-\[75\%\]{ max-width:85% !important; }
    
    /* Events cards - better padding and stacking */
    .rounded-2xl{ border-radius:1rem !important; }
    
    /* Event chat - full width on mobile */
    #event-chat-msgs{ max-height:200px !important; }
    
    /* Flex items - stack on mobile for better UX */
    .flex.justify-between{ flex-direction:column-reverse; align-items:stretch !important; }
    .flex.items-center.gap-2{ flex-wrap:wrap; }
    .flex.gap-2>button{ flex:1; min-width:100px; }
}
}

/* Small mobile (max-width: 480px) */
@media (max-width: 480px) {
    /* Even smaller text */
    body{ font-size:13px; }
    .text-2xl{ font-size:1.25rem !important; }
    .text-xl{ font-size:1.05rem !important; }
    
    /* Compact timetable */
    .timetable th, .timetable td{ padding:4px 2px; font-size:.55rem; }
    .cell-lesson{ font-size:.5rem; padding:2px 3px; }
    
    /* Smaller stats */
    .gpa-ring{ width:80px; height:80px; }
    
    /* Compact spacing */
    .p-6, .p-5, .p-4{ padding:0.75rem !important; }
    .px-4{ padding-left:0.75rem !important; padding-right:0.75rem !important; }
    .py-2{ padding-top:0.5rem !important; padding-bottom:0.5rem !important; }
    
    /* Stack flex items */
    .flex.gap-2, .flex.gap-3, .flex.gap-4{ flex-direction:column; }
    .flex.items-center{ align-items:stretch; }
}

/* Landscape mobile - special handling */
@media (max-height: 500px) and (orientation: landscape) {
    /* Reduce vertical spacing in landscape */
    .space-y-5>*+*{ margin-top:0.5rem !important; }
    .space-y-4>*+*{ margin-top:0.5rem !important; }
    .p-6, .p-5{ padding:0.75rem !important; }
    
    /* Hide large decorative elements */
    .text-6xl{ font-size:3rem !important; }
    .text-5xl{ font-size:2.5rem !important; }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    /* Larger tap targets for better accessibility */
    button, a, input[type="button"], select{ min-height:48px; }
    input[type="text"], input[type="password"], textarea{ min-height:48px; padding:12px; }
    
    /* Better touch feedback */
    button:active, a:active{ transform:scale(0.96); opacity:0.9; }
    
    /* Prevent text selection on repeated taps */
    button, a{ -webkit-tap-highlight-color:rgba(0,0,0,0.1); user-select:none; }
    
    /* Larger chat bubbles on touch devices */
    .bubble-user, .bubble-ai{ max-width:85%; }
    
    /* Better spacing for fingers */
    .space-y-2>*+*{ margin-top:0.75rem; }
    .gap-2{ gap:0.75rem; }
}
    
    /* Cards and spacing */
    .rounded-2xl{ border-radius:1rem; }
    .p-6{ padding:1rem; }
    .p-5{ padding:0.875rem; }
    
    /* Grid adjustments */
    .grid{ gap:0.75rem !important; }
    
    /* Text sizes */
    .text-2xl{ font-size:1.5rem; }
    .text-xl{ font-size:1.25rem; }
    .text-lg{ font-size:1.125rem; }
    
    /* Event cards - stack vertically */
    .max-w-5xl, .max-w-3xl{ max-width:100%; }
    
    /* Sidebar - always collapsed on mobile */
    .w-72, .w-80{ width:60px !important; }
    
    /* Form inputs */
    input[type="text"], input[type="password"], textarea, select{
        font-size:16px !important; /* Prevents zoom on iOS */
    }
}

/* Small Mobile (max-width: 480px) */
@media (max-width: 480px) {
    /* Even smaller text */
    body{ font-size:13px; }
    
    /* Reduce padding everywhere */
    .p-6, .p-5, .p-4{ padding:0.75rem; }
    .px-4{ padding-left:0.5rem; padding-right:0.5rem; }
    .py-3{ padding-top:0.5rem; padding-bottom:0.5rem; }
    
    /* Stack buttons vertically */
    .flex.gap-2{ flex-direction:column; gap:0.5rem; }
    
    /* Full width buttons on small screens */
    button{ width:100%; }
    
    /* Timetable even smaller */
    .timetable th, .timetable td{ padding:4px 2px; font-size:.6rem; }
    .cell-lesson{ font-size:.55rem; padding:2px 3px; }
    
    /* Chat adjustments */
    .max-w-\[75\%\]{ max-width:90% !important; }
    
    /* Hide some decorative elements on very small screens */
    .text-4xl{ font-size:2rem; }
    .text-3xl{ font-size:1.75rem; }
}

/* Landscape mobile optimization */
@media (max-height: 500px) and (orientation: landscape) {
    /* Reduce vertical padding */
    .py-16{ padding-top:2rem; padding-bottom:2rem; }
    .py-10{ padding-top:1.5rem; padding-bottom:1.5rem; }
    .space-y-5 > *{ margin-top:1rem; }
    .space-y-4 > *{ margin-top:0.75rem; }
}

/* Fix viewport for mobile browsers */
@supports (-webkit-touch-callout: none) {
    /* iOS Safari specific fixes */
    body{ 
        min-height:-webkit-fill-available;
        -webkit-overflow-scrolling:touch;
    }
}

/* Ensure tables are scrollable on mobile */
@media (max-width: 768px) {
    .overflow-x-auto{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
    }
}
    
    /* Stack grids on mobile */
    .grid{ grid-template-columns:1fr !important; }
}

/* Small Mobile (max-width: 480px) */
@media (max-width: 480px) {
    .timetable th, .timetable td{ padding:4px 2px; font-size:.6rem; }
    .cell-lesson{ font-size:.55rem; padding:2px 3px; }
    .gpa-ring{ width:80px; height:80px; }
}

/* Landscape mobile optimization */
@media (max-height: 500px) and (orientation: landscape) {
    .slide-up{ animation-duration:.2s; }
    .fade-in{ animation-duration:.2s; }
}
/* Print styles */
@media print {
    body{ font-size:12pt; color:#000; background:#fff; }
    /* Hide interactive elements */
    button, input, textarea, select, nav, .sidebar, [onclick]{ display:none !important; }
    /* Show only content */
    .flex-1{ width:100% !important; }
    /* Better page breaks */
    .rounded-2xl, .shadow-md{ box-shadow:none; border:1px solid #ddd; }
    .slide-up{ animation:none; opacity:1; }
    /* Timetable print optimization */
    .timetable{ page-break-inside:avoid; }
    .timetable th, .timetable td{ border:1px solid #000; padding:8px; }
}
</style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
// ===================== STATE =====================
let currentUser=null, currentView='login', selectedSubject=null, sidebarOpen=window.innerWidth>768, isRegistering=false;
let aiMessages=[], aiLoading=false;
let chatPartner=null; // {id, username, uid}
let chatMessages={}; // { "uid1_uid2": [{from,text,time}] }
let searchQuery='';

// Generate random ID â€” mixed letters + numbers, no fixed prefix
function genUID(){
    const chars='ABCDEFGHJKLMNPRSTUVWXYZ23456789'; // removed similar-looking: 0,O,1,I,Q
    let id='';
    for(let i=0;i<7;i++) id+=chars.charAt(Math.floor(Math.random()*chars.length));
    return id;
}

// ---- USERS ----
// roles: founder | admin | student
// Fixed UIDs for default accounts so they survive page reloads
let users=[
    {id:1, username:'Ø§Ù„Ù…Ø¤Ø³Ø³', password:'founder123', role:'founder', approved:true, uid:'KR7M4NX'},
    {id:2, username:'admin',  password:'admin123',   role:'admin',   approved:true, uid:'WT3P8LZ'}
];
let pendingUsers=[];
let announcements=[];

// ---- EVENTS ----
let events={
    regular:[], // ÙØ¹Ø§Ù„ÙŠØ§Øª Ø¹Ø§Ø¯ÙŠØ©: Ø£Ù„Ø¹Ø§Ø¨ØŒ Ù„Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù‚Ø·Ø§ØªØŒ Ø¬ÙˆØ§Ø¦Ø²
    school:[]   // ÙØ¹Ø§Ù„ÙŠØ§Øª Ù…Ø¯Ø±Ø³ÙŠØ©: Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
};

// ---- SUBJECTS ----
const subjects=[
    {id:1,name:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',color:'from-blue-500 to-blue-700',icon:'ğŸ“',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:2,name:'Ø¹Ù„ÙˆÙ…',color:'from-green-500 to-green-700',icon:'ğŸ”¬',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:3,name:'Ù„ØºØªÙŠ',color:'from-amber-500 to-amber-700',icon:'ğŸ“š',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:4,name:'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',color:'from-red-500 to-red-700',icon:'ğŸŒ',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:5,name:'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©',color:'from-emerald-500 to-emerald-700',icon:'â˜ªï¸',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:6,name:'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©',color:'from-orange-500 to-orange-700',icon:'ğŸŒ',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:7,name:'Ø§Ù„ÙÙ†ÙŠØ©',color:'from-pink-500 to-pink-700',icon:'ğŸ¨',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:8,name:'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©',color:'from-teal-500 to-teal-700',icon:'âš½',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:9,name:'Ø§Ù„Ø­ÙŠØ§ØªÙŠØ©',color:'from-purple-500 to-purple-700',icon:'ğŸƒ',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:10,name:'Ø§Ù„Ø±Ù‚Ù…ÙŠØ©',color:'from-cyan-500 to-cyan-700',icon:'ğŸ’»',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}},
    {id:11,name:'Ø§Ù„Ù†Ø´Ø§Ø·',color:'from-yellow-500 to-yellow-700',icon:'ğŸ­',content:{lessons:[],units:[],assignments:[],projects:[],references:[],exams:[],links:[],videos:[],images:[],files:[]}}
];

// ---- TIMETABLE: days x periods ----
// 5 days (Sun-Thu), 7 periods
let timetable = Array.from({length:5},()=>Array(7).fill(''));
const days5=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const periods=['Ø§Ù„Ø£ÙˆÙ„','Ø§Ù„Ø«Ø§Ù†ÙŠ','Ø§Ù„Ø«Ø§Ù„Ø«','Ø§Ù„Ø±Ø§Ø¨Ø¹','Ø§Ù„Ø®Ø§Ù…Ø³','Ø§Ù„Ø³Ø§Ø¯Ø³','Ø§Ù„Ø³Ø§Ø¨Ø¹'];

// ---- EXAMS ----
const examsData=[];
// Calculate subject progress dynamically based on content
function getSubjectProgress(subjectId){
    const sub=subjects.find(s=>s.id===subjectId);
    if(!sub)return 0;
    
    // Count all content items
    const total=
        sub.content.lessons.length +
        sub.content.units.length +
        sub.content.assignments.length +
        sub.content.projects.length +
        sub.content.references.length +
        sub.content.exams.length +
        sub.content.links.length +
        sub.content.videos.length +
        sub.content.images.length +
        sub.content.files.length;
    
    // Calculate progress (each item = 1%, max 100%)
    const progress=Math.min(total,100);
    return progress;
}

// ===================== localStorage =====================
function loadData(){
    const g=(k)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch(e){return null;}};
    if(g('q_users')){users=g('q_users');}
    if(g('q_pending')) pendingUsers=g('q_pending');
    if(g('q_ann'))     announcements=g('q_ann');
    if(g('q_cur')){
        const saved=g('q_cur');
        // Re-sync from users array so any role/name changes are picked up
        const fresh=users.find(u=>u.id===saved.id);
        currentUser=fresh||saved;
        currentView='home';
    }
    if(g('q_subj'))    {const l=g('q_subj'); subjects.forEach((s,i)=>{if(l[i])s.content=l[i].content;});}
    if(g('q_ai'))      aiMessages=g('q_ai');
    if(g('q_chat'))    chatMessages=g('q_chat');
    if(g('q_tt'))      timetable=g('q_tt');
}
function saveData(){
    localStorage.setItem('q_users',JSON.stringify(users));
    localStorage.setItem('q_pending',JSON.stringify(pendingUsers));
    localStorage.setItem('q_ann',JSON.stringify(announcements));
    // Always re-sync currentUser from the users array before saving
    if(currentUser){
        const fresh=users.find(u=>u.id===currentUser.id);
        if(fresh) currentUser=fresh;
        localStorage.setItem('q_cur',JSON.stringify(currentUser));
    } else {
        localStorage.removeItem('q_cur');
    }
    localStorage.setItem('q_subj',JSON.stringify(subjects));
    localStorage.setItem('q_ai',JSON.stringify(aiMessages));
    localStorage.setItem('q_chat',JSON.stringify(chatMessages));
    localStorage.setItem('q_tt',JSON.stringify(timetable));
}

// ===================== HELPERS =====================
function calcGPA(){const d=examsData.filter(e=>e.status==='done');return d.length?(d.reduce((s,e)=>s+e.score,0)/d.length/25).toFixed(2):0;}
function calcAvgScore(){const d=examsData.filter(e=>e.status==='done');return d.length?Math.round(d.reduce((s,e)=>s+e.score,0)/d.length):0;}
function daysUntilExam(){const n=examsData.filter(e=>e.status==='upcoming').sort((a,b)=>new Date(a.date)-new Date(b.date))[0];return n?Math.ceil((new Date(n.date)-new Date())/86400000):'â€”';}

// Get latest content item across all subjects and types
function getLatestContent(){
    let latest=null;
    const typeLabels={
        lessons:'ğŸ“– Ø§Ù„Ø¯Ø±ÙˆØ³',
        units:'ğŸ“‘ Ø§Ù„ÙˆØ­Ø¯Ø§Øª',
        assignments:'âœï¸ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª',
        projects:'ğŸ—ï¸ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
        references:'ğŸ”– Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª',
        exams:'ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª',
        links:'ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·',
        videos:'ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª',
        images:'ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±',
        files:'ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª'
    };
    subjects.forEach(sub=>{
        Object.keys(sub.content).forEach(type=>{
            sub.content[type].forEach(item=>{
                if(!latest || item.id>latest.id){
                    latest={...item, subjectName:sub.name, subjectIcon:sub.icon, typeLabel:typeLabels[type]||type, type};
                }
            });
        });
    });
    return latest;
}

function chatKey(uid1,uid2){ return [uid1,uid2].sort().join('_'); }
function isAdminOrFounder(){ return currentUser&&(currentUser.role==='admin'||currentUser.role==='founder'); }
function isFounder(){ return currentUser&&currentUser.role==='founder'; }

// ===================== AUTH =====================
function handleLogin(e){
    e.preventDefault();
    const u=document.getElementById('login-username').value, p=document.getElementById('login-password').value;
    const user=users.find(x=>x.username===u&&x.password===p&&x.approved);
    if(user){currentUser=user;currentView='home';saveData();render();}
    else alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
}
function handleRegister(e){
    e.preventDefault();
    const u=document.getElementById('register-username').value;
    if(users.some(x=>x.username===u)||pendingUsers.some(x=>x.username===u)){alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');return;}
    pendingUsers.push({id:Date.now(),username:u,password:'',role:'student',approved:false,uid:genUID()});
    isRegistering=false; saveData(); alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!'); render();
}
function approveUser(id){
    const u=pendingUsers.find(x=>x.id===id); if(!u)return;
    const pw=prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:'); if(!pw||!pw.trim()){alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±');return;}
    u.password=pw; users.push({...u,approved:true}); pendingUsers=pendingUsers.filter(x=>x.id!==id);
    saveData(); alert(`Ù‚ÙØ¨Ù„: ${u.username}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${pw}\nØ§Ù„Ù€ ID: ${u.uid}`); render();
}
function rejectUser(id){pendingUsers=pendingUsers.filter(x=>x.id!==id);saveData();render();}
function handleLogout(){if(confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){currentUser=null;currentView='login';chatPartner=null;localStorage.removeItem('q_cur');render();}}

// ===================== CONTENT =====================
function addContent(sid,type,title,desc,url){const s=subjects.find(x=>x.id===sid);if(s&&title.trim()){s.content[type].push({id:Date.now(),title,description:desc,url});saveData();render();}}
function showAddForm(key,sid){const t=prompt('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:');if(!t||!t.trim())return;const d=prompt('Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') ||'';let u='';if(key==='links'||key==='videos')u=prompt('Ø§Ù„Ø±Ø§Ø¨Ø·:')||'';addContent(sid,key,t,d,u);}
function deleteContent(sid,type,itemId){if(confirm('Ø­Ø°ÙØŸ')){const s=subjects.find(x=>x.id===sid);if(s){s.content[type]=s.content[type].filter(i=>i.id!==itemId);saveData();render();}}}
function editContent(sid,type,itemId){const s=subjects.find(x=>x.id===sid);if(!s)return;const item=s.content[type].find(i=>i.id===itemId);if(!item)return;const t=prompt('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:',item.title);if(t===null)return;if(t.trim())item.title=t.trim();const d=prompt('Ø§Ù„ÙˆØµÙ:',item.description||'');if(d!==null)item.description=d;if(type==='links'||type==='videos'){const u=prompt('Ø§Ù„Ø±Ø§Ø¨Ø·:',item.url||'');if(u!==null)item.url=u;}saveData();render();}
function addAnnouncement(){const t=prompt('Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†:');if(t&&t.trim()){announcements.unshift({id:Date.now(),text:t,date:new Date().toLocaleDateString('ar-SA')});saveData();render();}}
function deleteAnnouncement(id){if(confirm('Ø­Ø°ÙØŸ')){announcements=announcements.filter(a=>a.id!==id);saveData();render();}}

// ===================== USER MANAGEMENT =====================
function showUserPassword(id){const u=users.find(x=>x.id===id);if(u)alert(`Ø§Ù„Ø§Ø³Ù…: ${u.username}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${u.password}\nØ§Ù„Ù€ ID: ${u.uid}`);}
function deleteUser(id){const u=users.find(x=>x.id===id);if(u&&confirm(`Ø­Ø°Ù ${u.username}ØŸ`)){users=users.filter(x=>x.id!==id);saveData();render();}}
function editUsername(id){const u=users.find(x=>x.id===id);if(!u)return;const n=prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:',u.username);if(n&&n.trim()&&n!==u.username){if(users.some(x=>x.username===n&&x.id!==id)){alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');return;}u.username=n;saveData();render();}}
function editPassword(id){const u=users.find(x=>x.id===id);if(!u)return;const p=prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');if(p&&p.trim()){u.password=p;saveData();alert(`ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${p}`);render();}}
// Change role (founder only)
function changeRole(id){
    const u=users.find(x=>x.id===id); if(!u)return;
    const roles=['student','admin','founder'];
    const current=roles.indexOf(u.role);
    const choice=prompt(`Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${u.role}\n\nØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª:\n1 - Ø·Ø§Ù„Ø¨\n2 - Ù…Ø´Ø±Ù\n3 - Ù…Ø¤Ø³Ø³\n\nØ§Ø®ØªØ± Ø±Ù‚Ù…:`);
    if(choice==='1'){u.role='student';}else if(choice==='2'){u.role='admin';}else if(choice==='3'){u.role='founder';}else{return;}
    saveData(); alert(`ØªÙ… ØªØºÙŠÙŠØ± Ø±ØªØ¨Ø© ${u.username} Ø¥Ù„Ù‰: ${u.role}`); render();
}
// Founder adds admin directly
function founderAddAdmin(){
    const name=prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯:');if(!name||!name.trim())return;
    if(users.some(x=>x.username===name)){alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');return;}
    const pw=prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');if(!pw||!pw.trim())return;
    const uid=genUID();
    users.push({id:Date.now(),username:name,password:pw,role:'admin',approved:true,uid});
    saveData(); alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù:\nØ§Ù„Ø§Ø³Ù…: ${name}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${pw}\nØ§Ù„Ù€ ID: ${uid}`); render();
}

// ===================== TIMETABLE =====================
function editCell(day,period){
    if(!isAdminOrFounder())return;
    const current=timetable[day][period];
    const options=subjects.map((s,i)=>`${i+1}. ${s.name}`).join('\n');
    const choice=prompt(`Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:\n${options}\n\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø£Ùˆ Ø§Ø®Ù„Ù ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­Ø°Ù):`,current);
    if(choice===null)return;
    if(choice.trim()===''){timetable[day][period]='';saveData();render();return;}
    const idx=parseInt(choice)-1;
    if(idx>=0&&idx<subjects.length){timetable[day][period]=subjects[idx].name;saveData();render();}
    else alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­');
}

// ===================== AI =====================
async function sendAiMessage(){
    const input=document.getElementById('ai-input');const text=input.value.trim();if(!text||aiLoading)return;
    input.value=''; aiMessages.push({role:'user',text,time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'})});
    aiLoading=true; saveData(); render();
    try{
        const sys=currentUser&&currentUser.role!=='student'
            ?'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ. ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØµÙŠØ§ØºØ© Ø£Ø³Ø¦Ù„Ø©. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.'
            :'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø°ÙƒÙŠ. ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠÙŠÙ† ÙÙŠ Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ­Ù„ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­.';
        const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,system:sys,
                messages:aiMessages.filter(m=>m.role==='user'||m.role==='assistant').map(m=>({role:m.role,content:m.text})),
                tools:[{type:"web_search_20250305",name:"web_search"}]})});
        const data=await res.json();
        const reply=data.content.map(b=>b.type==='text'?b.text:'').filter(Boolean).join('\n')||'Ø­Ø¯Ø« Ø®Ø·Ø£.';
        aiMessages.push({role:'assistant',text:reply,time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'})});
    }catch(err){aiMessages.push({role:'assistant',text:'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'})});}
    aiLoading=false; saveData(); render();
    setTimeout(()=>{const inp=document.getElementById('ai-input');if(inp)inp.focus();},50);
}
function aiKeyDown(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendAiMessage();}}
function clearAiChat(){if(confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')){aiMessages=[];saveData();render();}}

// ===================== CHAT =====================
function searchUser(){
    const q=document.getElementById('chat-search').value.trim();
    searchQuery=q; render();
}
function startChat(uid){
    const partner=users.find(u=>u.uid===uid); if(!partner)return;
    chatPartner=partner; currentView='chat'; render();
}
function sendChatMsg(){
    if(!chatPartner)return;
    const input=document.getElementById('chat-input');const text=input.value.trim();if(!text)return;
    input.value='';
    const key=chatKey(currentUser.uid,chatPartner.uid);
    if(!chatMessages[key])chatMessages[key]=[];
    chatMessages[key].push({id:Date.now(),from:currentUser.uid,text,time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),reactions:[]});
    saveData(); render();
    setTimeout(()=>{const c=document.getElementById('chat-msgs');if(c)c.scrollTop=c.scrollHeight;},50);
}
function chatKeyDown(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMsg();}}

// ===================== EVENTS =====================
function addRegularEvent(){
    const types=['ğŸ® Ø£Ù„Ø¹Ø§Ø¨','ğŸ‘¥ Ù„Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡','ğŸ“¸ Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù‚Ø·Ø§Øª','ğŸ† ÙØ¹Ø§Ù„ÙŠØ© Ø¨Ø¬ÙˆØ§Ø¦Ø²'];
    const type=prompt('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:\n1 - '+types.join('\n2 - ').replace('2 - ','').replace('2 - ','3 - ').replace('3 - ','4 - '));
    if(!type||type<1||type>4)return;
    const title=prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:');
    if(!title)return;
    const desc=prompt('ÙˆØµÙ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:');
    const prize=type==='4'?prompt('Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):'):'';
    const maxPart=prompt('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¨Ø¯ÙˆÙ† Ø­Ø¯):');
    events.regular.push({
        id:Date.now(),
        type:types[parseInt(type)-1],
        title,
        desc:desc||'',
        prize:prize||'',
        date:new Date().toLocaleDateString('ar-SA'),
        maxParticipants:maxPart?parseInt(maxPart):null,
        participants:[],
        chat:[],
        ratings:[],
        screenshots:[]
    });
    saveData();render();
}
function addSchoolEvent(){
    const title=prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©:');
    if(!title)return;
    const desc=prompt('ÙˆØµÙ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:');
    const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© (Ù…Ø«Ø§Ù„: 2026-03-15):');
    const location=prompt('Ù…ÙƒØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:');
    const maxPart=prompt('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¨Ø¯ÙˆÙ† Ø­Ø¯):');
    events.school.push({
        id:Date.now(),
        title,
        desc:desc||'',
        date:date||new Date().toLocaleDateString('ar-SA'),
        location:location||'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',
        organizer:currentUser.username,
        maxParticipants:maxPart?parseInt(maxPart):null,
        participants:[],
        chat:[],
        ratings:[]
    });
    saveData();render();
}
function editEvent(type,id){
    const event=type==='regular'?events.regular.find(e=>e.id===id):events.school.find(e=>e.id===id);
    if(!event)return;
    const title=prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:',event.title);
    if(title)event.title=title;
    const desc=prompt('ÙˆØµÙ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:',event.desc);
    if(desc!==null)event.desc=desc;
    const maxPart=prompt('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø­Ø§Ù„ÙŠ: '+(event.maxParticipants||'Ø¨Ø¯ÙˆÙ† Ø­Ø¯')+'):');
    if(maxPart!==null)event.maxParticipants=maxPart?parseInt(maxPart):null;
    if(type==='school'){
        const date=prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:',event.date);
        if(date)event.date=date;
        const location=prompt('Ù…ÙƒØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:',event.location);
        if(location)event.location=location;
    }else{
        const prize=prompt('Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©:',event.prize||'');
        if(prize!==null)event.prize=prize;
    }
    saveData();render();
}
function deleteEvent(type,id){
    if(!confirm('Ø­Ø°Ù Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©ØŸ'))return;
    if(type==='regular')events.regular=events.regular.filter(e=>e.id!==id);
    else events.school=events.school.filter(e=>e.id!==id);
    saveData();render();
}
function joinEvent(type,id){
    const event=type==='regular'?events.regular.find(e=>e.id===id):events.school.find(e=>e.id===id);
    if(!event)return;
    if(event.participants.includes(currentUser.uid)){
        alert('Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„!');return;
    }
    if(event.maxParticipants&&event.participants.length>=event.maxParticipants){
        alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© Ù…Ù…ØªÙ„Ø¦Ø©!');return;
    }
    event.participants.push(currentUser.uid);
    saveData();render();
}
function sendEventChat(type,id){
    const event=type==='regular'?events.regular.find(e=>e.id===id):events.school.find(e=>e.id===id);
    if(!event)return;
    const input=document.getElementById('event-chat-'+id);
    const msg=input.value.trim();
    if(!msg)return;
    if(!event.chat)event.chat=[];
    event.chat.push({
        id:Date.now(),
        user:currentUser.username,
        uid:currentUser.uid,
        msg,
        time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        image:null
    });
    input.value='';
    saveData();render();
    setTimeout(()=>{const c=document.getElementById('event-chat-msgs-'+id);if(c)c.scrollTop=c.scrollHeight;},50);
}
function eventChatKeyDown(e,type,id){
    if(e.key==='Enter'&&!e.shiftKey){
        e.preventDefault();
        sendEventChat(type,id);
    }
}
function sendEventImage(type,id){
    const url=prompt('Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:');
    if(!url)return;
    const event=type==='regular'?events.regular.find(e=>e.id===id):events.school.find(e=>e.id===id);
    if(!event)return;
    if(!event.chat)event.chat=[];
    event.chat.push({
        id:Date.now(),
        user:currentUser.username,
        uid:currentUser.uid,
        msg:'',
        time:new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        image:url
    });
    saveData();render();
}
function rateEvent(type,id,stars){
    const event=type==='regular'?events.regular.find(e=>e.id===id):events.school.find(e=>e.id===id);
    if(!event)return;
    if(!event.ratings)event.ratings=[];
    const existing=event.ratings.find(r=>r.uid===currentUser.uid);
    if(existing){
        existing.stars=stars;
    }else{
        event.ratings.push({uid:currentUser.uid,user:currentUser.username,stars});
    }
    saveData();render();
}
function getEventRating(event){
    if(!event.ratings||event.ratings.length===0)return 0;
    const sum=event.ratings.reduce((a,r)=>a+r.stars,0);
    return(sum/event.ratings.length).toFixed(1);
}
function shareScreenshot(id){
    const url=prompt('Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ù„Ù‚Ø·Ø©:');
    if(!url)return;
    const event=events.regular.find(e=>e.id===id);
    if(!event)return;
    if(!event.screenshots)event.screenshots=[];
    event.screenshots.push({user:currentUser.username,url,time:new Date().toLocaleTimeString('ar-SA')});
    saveData();render();
}
function deleteChatMsg(msgId){
    if(!confirm('Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ'))return;
    const key=chatKey(currentUser.uid,chatPartner.uid);
    chatMessages[key]=chatMessages[key].filter(m=>m.id!==msgId);
    saveData();render();
}
function editChatMsg(msgId){
    const key=chatKey(currentUser.uid,chatPartner.uid);
    const msg=chatMessages[key].find(m=>m.id===msgId);
    if(!msg)return;
    const newText=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:',msg.text);
    if(newText===null||!newText.trim())return;
    msg.text=newText.trim();
    msg.edited=true;
    saveData();render();
}
function addReaction(msgId){
    const emoji=prompt('Ø§Ø®ØªØ± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ:\nâ¤ï¸ ğŸ˜‚ ğŸ˜® ğŸ˜¢ ğŸ˜¡ ğŸ‘ ğŸ‘ ğŸ”¥ â­ ğŸ‰\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ:');
    if(!emoji||!emoji.trim())return;
    const key=chatKey(currentUser.uid,chatPartner.uid);
    const msg=chatMessages[key].find(m=>m.id===msgId);
    if(!msg)return;
    if(!msg.reactions)msg.reactions=[];
    // check if user already reacted
    const existing=msg.reactions.find(r=>r.uid===currentUser.uid);
    if(existing){existing.emoji=emoji.trim();}
    else{msg.reactions.push({uid:currentUser.uid,emoji:emoji.trim()});}
    saveData();render();
}

// ===================== RENDER =====================

function renderLoginPage(){
    return `<div class="min-h-screen flex items-center justify-center p-4" style="background:linear-gradient(135deg,#004d26,#006C35,#00A352)">
        <div class="absolute inset-0 overflow-hidden"><div class="absolute -top-32 -right-32 w-96 h-96 bg-white rounded-full opacity-5"></div><div class="absolute -bottom-32 -left-32 w-96 h-96 bg-white rounded-full opacity-5"></div></div>
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md relative z-10">
            <div class="text-center mb-6">
                <div class="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg" style="background:linear-gradient(135deg,#006C35,#00A352)"><span class="text-4xl">ğŸ“</span></div>
                <h1 class="text-4xl font-bold" style="color:#006C35">Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©</h1>
                <p class="text-gray-500">Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
            </div>
            ${!isRegistering?`
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div><label class="block text-gray-700 font-semibold mb-1 text-right">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="login-username" type="text" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-right" required dir="rtl"></div>
                <div><label class="block text-gray-700 font-semibold mb-1 text-right">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="login-password" type="password" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-right" required dir="rtl"></div>
                <button type="submit" class="w-full text-white py-3 rounded-xl font-bold shadow" style="background:linear-gradient(135deg,#006C35,#00A352)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" onclick="isRegistering=true;render()" class="w-full bg-white border-2 border-green-600 text-green-700 py-3 rounded-xl font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </form>`:`
            <form onsubmit="handleRegister(event)" class="space-y-4">
                <div><label class="block text-gray-700 font-semibold mb-1 text-right">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="register-username" type="text" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-right" required dir="rtl"></div>
                <div class="bg-green-50 border-r-4 border-green-500 p-3 rounded-lg"><p class="text-sm text-green-800 text-right">Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù</p></div>
                <button type="submit" class="w-full text-white py-3 rounded-xl font-bold shadow" style="background:linear-gradient(135deg,#006C35,#00A352)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                <button type="button" onclick="isRegistering=false;render()" class="w-full bg-white border-2 border-gray-300 text-gray-600 py-3 rounded-xl font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </form>`}
        </div>
    </div>`;
}

function renderSidebar(){
    const nav=[
        {key:'home',icon:'ğŸ ',label:'Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'},
        {key:'subjects',icon:'ğŸ“š',label:'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©'},
        {key:'timetable',icon:'ğŸ“…',label:'Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ'},
        {key:'ai',icon:'ğŸ¤–',label:'Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ'},
        {key:'events',icon:'ğŸ‰',label:'Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª'},
        {key:'news',icon:'ğŸ“°',label:'Ø£Ø®Ø¨Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…'},
        {key:'chat',icon:'ğŸ’¬',label:'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©'},
        {key:'profile',icon:'ğŸ‘¤',label:'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ'},
    ];
    if(isAdminOrFounder()) nav.push({key:'admin',icon:'ğŸ›¡ï¸',label:'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù'});
    if(isFounder())        nav.push({key:'founder',icon:'ğŸ‘‘',label:'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ø³Ø³'});

    return `<div class="${sidebarOpen?'w-72 md:w-80 lg:w-96':'w-16 md:w-20'} transition-all duration-300 flex flex-col shadow-2xl flex-shrink-0" style="min-height:100vh;background:#1a1f2e">
        <!-- Header -->
        <div class="p-5 flex items-center justify-between border-b" style="border-color:#2d3548">
            ${sidebarOpen?`<div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-2xl" style="background:#006C35">ğŸ“</div>
                <div class="text-right">
                    <h2 class="text-white font-bold text-lg">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
                    <p class="text-gray-400 text-xs">Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©</p>
                </div>
            </div>`:''}
            <button onclick="sidebarOpen=!sidebarOpen;render()" class="p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-all">
                ${sidebarOpen?'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>':'<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>'}
            </button>
        </div>
        
        <!-- User info -->
        ${sidebarOpen?`<div class="p-4 mx-3 mt-3 rounded-xl" style="background:#2d3548">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl" style="background:linear-gradient(135deg,#006C35,#00A352);color:white">
                    ${currentUser.username.charAt(0)}
                </div>
                <div class="flex-1 text-right min-w-0">
                    <p class="text-white font-semibold truncate">${currentUser.username}</p>
                    <p class="text-gray-400 text-xs">${currentUser.role==='founder'?'ğŸ‘‘ Ù…Ø¤Ø³Ø³':currentUser.role==='admin'?'ğŸ›¡ï¸ Ù…Ø´Ø±Ù':'ğŸ‘¨â€ğŸ“ Ø·Ø§Ù„Ø¨'}</p>
                </div>
            </div>
        </div>`:''}
        
        <!-- Navigation -->
        <nav class="flex-1 p-3 space-y-2 overflow-y-auto mt-2">
            ${nav.map(item=>{
                const isActive=currentView===item.key&&!selectedSubject;
                return`<button onclick="currentView='${item.key}';selectedSubject=null;chatPartner=null;searchQuery='';if(window.innerWidth<=768)sidebarOpen=false;render()" 
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${isActive?'text-white shadow-lg':'text-gray-400 hover:text-white hover:bg-gray-700/50'}" 
                    style="${isActive?'background:linear-gradient(135deg,#006C35,#00A352)':''}">
                    <span class="text-xl flex-shrink-0">${item.icon}</span>
                    ${sidebarOpen?`<span class="font-medium text-right">${item.label}</span>`:''}
                </button>`;
            }).join('')}
        </nav>
        
        <!-- Logout -->
        <div class="p-3 border-t" style="border-color:#2d3548">
            <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-red-400 hover:text-white hover:bg-red-600/20">
                <span class="text-xl">ğŸšª</span>
                ${sidebarOpen?'<span class="font-medium">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>':''}
            </button>
        </div>
    </div>`;
}

// ---------- HOME ----------
function renderHomePage(){
    const latestItem=getLatestContent();
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-6xl mx-auto space-y-5">
        <!-- banner -->
        <div class="rounded-3xl p-8 text-white shadow-xl slide-up" style="background:linear-gradient(135deg,#004d26,#006C35,#00A352)">
            <h1 class="text-4xl font-bold text-right">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ${currentUser.username}</h1>
            <p class="text-green-200 text-lg text-right">Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© â€¢ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© 2025-2026</p>
        </div>
        <!-- stats -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            ${(()=>{
                const stats=[{label:'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©',value:subjects.length,icon:'ğŸ“š'}];
                if(isAdminOrFounder()) stats.push({label:'Ø§Ù„Ø·Ù„Ø§Ø¨',value:users.filter(u=>u.role==='student').length,icon:'ğŸ‘¥'});
                stats.push({label:'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª',value:announcements.length,icon:'ğŸ“¢'});
                return stats;
            })().map((s,i)=>`<div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:${i*.08}s"><div class="flex items-center justify-between mb-1"><span class="text-2xl">${s.icon}</span><span class="text-xs text-gray-500 text-right">${s.label}</span></div><p class="text-3xl font-bold text-gray-800 text-right">${s.value}</p></div>`).join('')}
        </div>
        <!-- top subject + progress -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Ø¢Ø®Ø± Ù…Ø­ØªÙˆÙ‰ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ -->
            <div class="bg-white rounded-2xl shadow-md p-6 slide-up" style="animation-delay:.25s">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-right">ğŸ†• Ø¢Ø®Ø± Ù…Ø­ØªÙˆÙ‰ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡</h3>
                ${!latestItem?'<p class="text-gray-400 text-center py-6">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯</p>':`
                <div class="flex items-center gap-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-5">
                    <span class="text-5xl">${latestItem.subjectIcon}</span>
                    <div class="flex-1 text-right">
                        <p class="text-xl font-bold text-gray-800">${latestItem.title}</p>
                        ${latestItem.description?`<p class="text-sm text-gray-600 mt-1">${latestItem.description}</p>`:''}
                        <div class="mt-2 flex gap-2 justify-end flex-wrap">
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2.5 py-0.5 rounded-full font-semibold">${latestItem.subjectName}</span>
                            <span class="bg-purple-100 text-purple-700 text-xs px-2.5 py-0.5 rounded-full font-semibold">${latestItem.typeLabel}</span>
                        </div>
                        ${latestItem.url?`<a href="${latestItem.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs mt-2 inline-block">ğŸ”— ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>`:''}
                    </div>
                </div>`}
            </div>
            <!-- progress bars -->
            <div class="bg-white rounded-2xl shadow-md p-6 slide-up" style="animation-delay:.3s">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-right">ğŸ“š ØªÙ‚Ø¯Ù… Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                <div class="space-y-2.5">${subjects.slice(0,5).map(s=>{const p=getSubjectProgress(s.id);return`<div><div class="flex justify-between text-xs text-gray-500 mb-1"><span>${p}%</span><span>${s.name}</span></div><div class="progress-track h-2"><div class="progress-fill" style="width:${p}%"></div></div></div>`;}).join('')}</div>
            </div>
        </div>
        <!-- announcements -->
        <div class="bg-white rounded-2xl shadow-md p-6 slide-up" style="animation-delay:.35s">
            <h3 class="text-lg font-bold text-gray-800 mb-3 text-right">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
            <div class="space-y-2">${announcements.length===0?'<p class="text-gray-400 text-center py-3">Ù„Ø§ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>':announcements.map(a=>`<div class="border-r-4 border-green-500 bg-green-50 p-3 rounded-lg"><p class="text-gray-800 text-right text-sm">${a.text}</p><p class="text-xs text-gray-500 text-right mt-0.5">${a.date}</p></div>`).join('')}</div>
        </div>
        <!-- quick links -->
        <div class="grid grid-cols-3 gap-4">
            ${[{v:'ai',i:'ğŸ¤–',l:'Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ',c:'from-indigo-500 to-indigo-600'},{v:'timetable',i:'ğŸ“…',l:'Ø§Ù„Ø¬Ø¯ÙˆÙ„',c:'from-green-500 to-green-600'},{v:'chat',i:'ğŸ’¬',l:'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©',c:'from-blue-500 to-blue-600'}].map(x=>`<button onclick="currentView='${x.v}';render()" class="bg-gradient-to-br ${x.c} text-white rounded-2xl p-4 shadow-md hover:shadow-lg transform hover:scale-105 transition-all text-center"><span class="text-2xl">${x.i}</span><p class="font-bold text-sm mt-1">${x.l}</p></button>`).join('')}
        </div>
    </div></div>`;
}

// ---------- TIMETABLE ----------
function renderTimetablePage(){
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-6xl mx-auto space-y-5">
        <div class="flex items-center justify-between">
            ${isAdminOrFounder()?'<button onclick="resetTimetable()" class="text-sm text-red-500 hover:text-red-700 font-semibold">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>':'<div></div>'}
            <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h1>
        </div>
        ${isAdminOrFounder()?'<div class="bg-blue-50 border-r-4 border-blue-500 p-3 rounded-lg"><p class="text-sm text-blue-800 text-right">ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ù†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©</p></div>':''}
        <div class="bg-white rounded-2xl shadow-xl p-6 slide-up" style="animation-delay:.1s">
            <!-- School header -->
            <div class="text-center mb-6 pb-4 border-b-2 border-green-600">
                <h2 class="text-2xl font-bold mb-2" style="color:#006C35">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                <p class="text-sm text-gray-600">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="timetable w-full border-collapse">
                    <thead><tr>
                        <th style="width:100px">Ø§Ù„Ø­ØµØ©</th>
                        ${days5.map(d=>`<th>${d}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        ${periods.map((p,pi)=>`<tr>
                            <td>${p}</td>
                            ${days5.map((_,di)=>{
                                const lesson=timetable[di][pi];
                                const clickable=isAdminOrFounder()?`onclick="editCell(${di},${pi})" class="cursor-pointer"`:'';
                                return `<td ${clickable}>${lesson?`<div class="cell-lesson">${lesson}</div>`:`<span class="text-gray-300 text-xs">${isAdminOrFounder()?'+ Ø¥Ø¶Ø§ÙØ©':'â€”'}</span>`}</td>`;
                            }).join('')}
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            
            ${isAdminOrFounder()?'<div class="mt-4 text-xs text-gray-500 text-right">ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø®Ù„Ù Ø§Ù„Ø®Ø§Ù†Ø© ÙØ§Ø±ØºØ© Ù„Ù„Ø­Ø°Ù</div>':''}
        </div>
    </div></div>`;
}
function resetTimetable(){if(confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')){timetable=Array.from({length:5},()=>Array(7).fill(''));saveData();render();}}

// ---------- AI ----------
function renderAiPage(){
    return `<div class="flex-1 flex flex-col" style="min-height:0">
        <div class="p-4 border-b bg-white flex items-center justify-between flex-shrink-0">
            <button onclick="clearAiChat()" class="text-sm text-red-500">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <div class="text-right"><h2 class="text-xl font-bold text-gray-800">ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</h2><p class="text-xs text-gray-500">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ + Ø§Ù„Ø¨Ø­Ø«</p></div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" id="ai-messages-container">
            ${aiMessages.length===0?`<div class="text-center py-16"><span class="text-6xl">ğŸ¤–</span><p class="text-gray-500 mt-3">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ</p></div>`:
            aiMessages.map(m=>`<div class="flex ${m.role==='user'?'justify-start':'justify-end'} msg-in"><div class="max-w-[75%] rounded-2xl px-4 py-2.5 shadow-sm ${m.role==='user'?'bubble-user text-white rounded-tl-none':'bubble-ai text-gray-800 rounded-tr-none'}"><p class="text-right whitespace-pre-wrap text-sm">${m.text}</p><p class="text-xs mt-1 ${m.role==='user'?'text-green-200':'text-gray-400'} text-right">${m.time}</p></div></div>`).join('')}
            ${aiLoading?'<div class="flex justify-end"><div class="bubble-ai rounded-2xl rounded-tr-none px-4 py-2.5"><span class="spin text-sm">â³</span> ÙŠÙƒØªØ¨...</div></div>':''}
        </div>
        <div class="p-4 bg-white border-t flex-shrink-0">
            <div class="flex gap-2 items-end">
                <textarea id="ai-input" onkeydown="aiKeyDown(event)" placeholder="Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¯Ø±Ø§Ø³ÙŠ..." dir="rtl" class="flex-1 px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-right resize-none text-sm" rows="2"></textarea>
                <button onclick="sendAiMessage()" class="text-white px-4 py-2.5 rounded-xl font-bold shadow flex-shrink-0" style="background:linear-gradient(135deg,#006C35,#00A352)">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            <p class="text-xs text-gray-400 text-right mt-1">Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</p>
        </div>
    </div>`;
}

// ---------- EXAMS ----------
function renderExamsPage(){
    const upcoming=examsData.filter(e=>e.status==='upcoming').sort((a,b)=>new Date(a.date)-new Date(b.date));
    const done=examsData.filter(e=>e.status==='done');
    const gpa=calcGPA(),avg=calcAvgScore(),gpaP=(gpa/4)*100;
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-5xl mx-auto space-y-5">
        <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-2xl shadow-md p-5 flex flex-col items-center slide-up">
                <div class="gpa-ring"><svg width="130" height="130" viewBox="0 0 130 130"><circle cx="65" cy="65" r="54" fill="none" stroke="#e2e8f0" stroke-width="11"/><circle cx="65" cy="65" r="54" fill="none" stroke="#006C35" stroke-width="11" stroke-dasharray="${2*Math.PI*54}" stroke-dashoffset="${2*Math.PI*54*(1-gpaP/100)}" stroke-linecap="round"/></svg><div class="val"><span class="text-2xl font-bold text-gray-800">${gpa}</span><span class="text-xs text-gray-500">GPA</span></div></div>
            </div>
            <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.08s"><h4 class="text-xs text-gray-500 text-right mb-2">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h4><p class="text-4xl font-bold text-right" style="color:#006C35">${avg}<span class="text-sm text-gray-400">/100</span></p><div class="progress-track h-2 mt-3"><div class="progress-fill" style="width:${avg}%"></div></div></div>
            <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.12s"><h4 class="text-xs text-gray-500 text-right mb-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4><div class="space-y-1.5 text-right text-sm">${[['Ù…ÙƒØªÙ…Ù„Ø©',done.length],['Ù‚Ø§Ø¯Ù…Ø©',upcoming.length],['Ø£Ø¹Ù„Ù‰',done.length>0?Math.max(...done.map(e=>e.score))+'%':'â€”'],['Ø£Ø¯Ù†Ù‰',done.length>0?Math.min(...done.map(e=>e.score))+'%':'â€”']].map(([l,v])=>`<div class="flex justify-between"><span class="text-gray-500">${l}</span><span class="font-bold text-gray-700">${v}</span></div>`).join('')}</div></div>
        </div>
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.18s">
            <h3 class="text-lg font-bold text-gray-800 mb-3 text-right">ğŸ“… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h3>
            <div class="space-y-2">${upcoming.length===0?'<p class="text-gray-400 text-center py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</p>':upcoming.map(ex=>{const days=Math.ceil((new Date(ex.date)-new Date())/86400000);return`<div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-xl p-3"><div class="flex items-center gap-2"><span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${days}Ø£ÙŠØ§Ù…</span></div><div class="text-right"><p class="font-bold text-gray-800 text-sm">${ex.subject}</p><p class="text-xs text-gray-500">${new Date(ex.date).toLocaleDateString('ar-SA')} â€¢ ${ex.time}</p></div></div>`;}).join('')}</div>
        </div>
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.22s">
            <h3 class="text-lg font-bold text-gray-800 mb-3 text-right">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
            <div class="space-y-2">${done.length===0?'<p class="text-gray-400 text-center py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</p>':done.map(ex=>{const c=ex.score>=90?'emerald':ex.score>=70?'blue':'red';return`<div class="flex items-center justify-between bg-${c}-50 border border-${c}-200 rounded-xl p-3"><div class="flex items-center gap-2"><span class="font-bold text-lg text-${c}-600">${ex.score}%</span><div class="w-20 progress-track h-1.5"><div class="progress-fill" style="width:${ex.score}%"></div></div></div><div class="text-right"><p class="font-bold text-gray-800 text-sm">${ex.subject}</p><p class="text-xs text-gray-500">${new Date(ex.date).toLocaleDateString('ar-SA')}</p></div></div>`;}).join('')}</div>
        </div>
    </div></div>`;
}

// ---------- NEWS ----------
function renderNewsPage(){
    const news=[];
    const cc={'Ù‚Ø±Ø§Ø±Ø§Øª ÙˆØ²Ø§Ø±ÙŠØ©':'bg-blue-100 text-blue-700','Ø§Ù„ØªÙ‚ÙˆÙŠÙ…':'bg-green-100 text-green-700','ØªÙ†Ø¨ÙŠÙ‡Ø§Øª':'bg-red-100 text-red-700','Ø£Ø®Ø¨Ø§Ø±':'bg-purple-100 text-purple-700'};
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-3xl mx-auto space-y-4">
        <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ“° Ø£Ø®Ø¨Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…</h1>
        ${news.length===0?'<div class="text-center py-16"><span class="text-6xl">ğŸ“°</span><p class="text-gray-500 mt-4 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p><p class="text-gray-400 text-sm mt-2">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹</p></div>':
        news.map((n,i)=>`<div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:${i*.07}s"><div class="flex items-start gap-3"><div class="flex-1"><div class="flex items-center justify-between mb-1 flex-wrap gap-1"><span class="text-xs ${cc[n.cat]||'bg-gray-100 text-gray-600'} px-2 py-0.5 rounded-full">${n.cat}</span><span class="text-xs text-gray-400">${new Date(n.date).toLocaleDateString('ar-SA')}</span></div><h3 class="font-bold text-gray-800 text-right">${n.title}</h3><p class="text-gray-500 text-xs text-right mt-1">${n.desc}</p></div><span class="text-2xl">${n.icon}</span></div></div>`).join('')}
    </div></div>`;
}

// ---------- EVENTS ----------
let eventTab='regular'; // regular or school
function renderEventsPage(){
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-5xl mx-auto space-y-5">
        <div class="flex flex-col-reverse md:flex-row items-stretch md:items-center justify-between gap-3">
            <h1 class="text-2xl font-bold text-gray-800 slide-up text-center md:text-right">ğŸ‰ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</h1>
            ${isAdminOrFounder()?`<div class="flex flex-col sm:flex-row gap-2">
                <button onclick="addRegularEvent()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all whitespace-nowrap">+ ÙØ¹Ø§Ù„ÙŠØ© Ø¹Ø§Ø¯ÙŠØ©</button>
                <button onclick="addSchoolEvent()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all whitespace-nowrap">+ ÙØ¹Ø§Ù„ÙŠØ© Ù…Ø¯Ø±Ø³ÙŠØ©</button>
            </div>`:''}
        </div>
        
        <!-- Tabs -->
        <div class="flex gap-3 bg-white rounded-xl p-2 shadow-md">
            <button onclick="eventTab='regular';render()" class="flex-1 py-2.5 rounded-lg font-semibold transition-all ${eventTab==='regular'?'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow':'text-gray-600 hover:bg-gray-100'}">
                ğŸ® Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (${events.regular.length})
            </button>
            <button onclick="eventTab='school';render()" class="flex-1 py-2.5 rounded-lg font-semibold transition-all ${eventTab==='school'?'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow':'text-gray-600 hover:bg-gray-100'}">
                ğŸ« Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© (${events.school.length})
            </button>
        </div>
        
        <!-- Regular Events -->
        ${eventTab==='regular'?`
            <div class="space-y-6">
                ${events.regular.length===0?`<div class="text-center py-16 bg-white rounded-2xl shadow-md">
                    <span class="text-6xl">ğŸ®</span>
                    <p class="text-gray-500 mt-4 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¹Ø§Ù„ÙŠØ§Øª Ø¹Ø§Ø¯ÙŠØ©</p>
                    <p class="text-gray-400 text-sm mt-2">Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ØªØ´Ù…Ù„: Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ØŒ Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù„Ù‚Ø·Ø§ØªØŒ ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø¨Ø¬ÙˆØ§Ø¦Ø²</p>
                </div>`:events.regular.map((e,i)=>{
                    const rating=getEventRating(e);
                    const userRating=e.ratings?.find(r=>r.uid===currentUser.uid)?.stars||0;
                    const isFull=e.maxParticipants&&e.participants.length>=e.maxParticipants;
                    return`<div class="bg-white rounded-2xl shadow-md overflow-hidden slide-up" style="animation-delay:${i*.05}s">
                        <!-- Header -->
                        <div class="p-6 pb-4">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap mb-2">
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">${e.type}</span>
                                        <span class="text-xs text-gray-400">${e.date}</span>
                                        ${e.maxParticipants?`<span class="px-2 py-1 ${isFull?'bg-red-100 text-red-600':'bg-blue-100 text-blue-600'} text-xs rounded-full">${e.participants.length}/${e.maxParticipants} ${isFull?'(Ù…Ù…ØªÙ„Ø¦Ø©)':''}</span>`:`<span class="text-xs text-gray-500">ğŸ‘¥ ${e.participants.length}</span>`}
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 text-right">${e.title}</h3>
                                    ${e.desc?`<p class="text-gray-600 text-sm text-right mt-2">${e.desc}</p>`:''}
                                    ${e.prize?`<div class="mt-3 p-3 bg-yellow-50 border-r-4 border-yellow-400 rounded-lg">
                                        <p class="text-sm font-semibold text-yellow-700">ğŸ† Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: ${e.prize}</p>
                                    </div>`:''}
                                    
                                    <!-- Rating Display -->
                                    <div class="flex items-center gap-2 mt-3">
                                        <div class="flex gap-1">
                                            ${[1,2,3,4,5].map(s=>`<span class="text-lg">${s<=Math.round(rating)?'â­':'â˜†'}</span>`).join('')}
                                        </div>
                                        <span class="text-sm text-gray-600">${rating>0?rating+' Ù…Ù† 5':' Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª'}</span>
                                        ${e.ratings?.length>0?`<span class="text-xs text-gray-400">(${e.ratings.length} ØªÙ‚ÙŠÙŠÙ…)</span>`:''}
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    ${isAdminOrFounder()?`
                                        <button onclick="editEvent('regular',${e.id})" class="text-blue-500 hover:text-blue-700 p-2" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                                        <button onclick="deleteEvent('regular',${e.id})" class="text-red-500 hover:text-red-700 p-2" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                    `:''}
                                </div>
                            </div>
                            
                            <!-- Join Button -->
                            ${!e.participants.includes(currentUser.uid)?`
                                <button onclick="joinEvent('regular',${e.id})" class="w-full px-4 py-2.5 ${isFull?'bg-gray-300 cursor-not-allowed':'bg-green-500 hover:bg-green-600'} text-white rounded-lg font-semibold transition-all" ${isFull?'disabled':''}>
                                    ${isFull?'ğŸ”’ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© Ù…Ù…ØªÙ„Ø¦Ø©':'âœ“ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ©'}
                                </button>
                            `:`<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                <span class="text-green-700 font-semibold">âœ“ Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</span>
                            </div>`}
                        </div>
                        
                        <!-- Chat Section (only for participants) -->
                        ${e.participants.includes(currentUser.uid)?`
                            <div class="border-t border-gray-100 bg-gray-50 p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 text-right">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</h4>
                                <div class="bg-white rounded-lg p-3 mb-3 max-h-60 overflow-y-auto space-y-2" id="event-chat-msgs-${e.id}">
                                    ${!e.chat||e.chat.length===0?`<p class="text-gray-400 text-sm text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>`:
                                    e.chat.map(m=>{
                                        const isMe=m.uid===currentUser.uid;
                                        return`<div class="flex ${isMe?'justify-end':'justify-start'}">
                                            <div class="max-w-[75%] ${isMe?'bg-green-100':'bg-gray-100'} rounded-lg px-3 py-2">
                                                <p class="text-xs font-semibold ${isMe?'text-green-700':'text-gray-700'} mb-1">${m.user}</p>
                                                ${m.image?`<img src="${m.image}" class="rounded-lg max-w-full mb-1" style="max-height:200px">`:''}
                                                ${m.msg?`<p class="text-sm text-gray-800">${m.msg}</p>`:''}
                                                <p class="text-xs text-gray-400 mt-1">${m.time}</p>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="sendEventImage('regular',${e.id})" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">ğŸ“·</button>
                                    <input id="event-chat-${e.id}" onkeydown="eventChatKeyDown(event,'regular',${e.id})" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-green-500 text-sm">
                                    <button onclick="sendEventChat('regular',${e.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold text-sm">Ø¥Ø±Ø³Ø§Ù„</button>
                                </div>
                            </div>
                            
                            <!-- Rating Section -->
                            <div class="border-t border-gray-100 p-4 bg-gray-50">
                                <h4 class="font-semibold text-gray-800 mb-2 text-right">â­ Ù‚ÙŠÙ‘Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</h4>
                                <div class="flex justify-center gap-2">
                                    ${[1,2,3,4,5].map(s=>`<button onclick="rateEvent('regular',${e.id},${s})" class="text-3xl hover:scale-110 transition-transform" title="${s} Ù†Ø¬ÙˆÙ…">${s<=userRating?'â­':'â˜†'}</button>`).join('')}
                                </div>
                                ${userRating>0?`<p class="text-xs text-center text-gray-500 mt-2">ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${userRating} Ù†Ø¬ÙˆÙ…</p>`:''}
                            </div>
                        `:''}
                    </div>`;
                }).join('')}
            </div>
        `:''}
        
        <!-- School Events -->
        ${eventTab==='school'?`
            <div class="space-y-6">
                ${events.school.length===0?`<div class="text-center py-16 bg-white rounded-2xl shadow-md">
                    <span class="text-6xl">ğŸ«</span>
                    <p class="text-gray-500 mt-4 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¹Ø§Ù„ÙŠØ§Øª Ù…Ø¯Ø±Ø³ÙŠØ©</p>
                    <p class="text-gray-400 text-sm mt-2">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</p>
                </div>`:events.school.map((e,i)=>{
                    const rating=getEventRating(e);
                    const userRating=e.ratings?.find(r=>r.uid===currentUser.uid)?.stars||0;
                    const isFull=e.maxParticipants&&e.participants.length>=e.maxParticipants;
                    return`<div class="bg-white rounded-2xl shadow-md overflow-hidden slide-up" style="animation-delay:${i*.05}s">
                        <!-- Header -->
                        <div class="p-6 pb-4">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap mb-2">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">ğŸ« Ù…Ø¯Ø±Ø³ÙŠØ©</span>
                                        <span class="text-xs text-gray-400">ğŸ“… ${e.date}</span>
                                        <span class="text-xs text-gray-400">ğŸ“ ${e.location}</span>
                                        ${e.maxParticipants?`<span class="px-2 py-1 ${isFull?'bg-red-100 text-red-600':'bg-blue-100 text-blue-600'} text-xs rounded-full">${e.participants.length}/${e.maxParticipants}</span>`:`<span class="text-xs text-gray-500">ğŸ‘¥ ${e.participants.length}</span>`}
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800 text-right">${e.title}</h3>
                                    ${e.desc?`<p class="text-gray-600 text-sm text-right mt-2">${e.desc}</p>`:''}
                                    <p class="text-xs text-gray-500 mt-3">Ø§Ù„Ù…Ù†Ø¸Ù…: ${e.organizer}</p>
                                    
                                    <!-- Rating Display -->
                                    <div class="flex items-center gap-2 mt-3">
                                        <div class="flex gap-1">
                                            ${[1,2,3,4,5].map(s=>`<span class="text-lg">${s<=Math.round(rating)?'â­':'â˜†'}</span>`).join('')}
                                        </div>
                                        <span class="text-sm text-gray-600">${rating>0?rating+' Ù…Ù† 5':'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª'}</span>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    ${isAdminOrFounder()?`
                                        <button onclick="editEvent('school',${e.id})" class="text-blue-500 hover:text-blue-700 p-2" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                                        <button onclick="deleteEvent('school',${e.id})" class="text-red-500 hover:text-red-700 p-2" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                    `:''}
                                </div>
                            </div>
                            
                            <!-- Join Button -->
                            ${!e.participants.includes(currentUser.uid)?`
                                <button onclick="joinEvent('school',${e.id})" class="w-full px-4 py-2.5 ${isFull?'bg-gray-300 cursor-not-allowed':'bg-blue-500 hover:bg-blue-600'} text-white rounded-lg font-semibold transition-all" ${isFull?'disabled':''}>
                                    ${isFull?'ğŸ”’ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© Ù…Ù…ØªÙ„Ø¦Ø©':'âœ“ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ©'}
                                </button>
                            `:`<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                                <span class="text-blue-700 font-semibold">âœ“ Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</span>
                            </div>`}
                        </div>
                        
                        <!-- Chat Section -->
                        ${e.participants.includes(currentUser.uid)?`
                            <div class="border-t border-gray-100 bg-gray-50 p-4">
                                <h4 class="font-semibold text-gray-800 mb-3 text-right">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</h4>
                                <div class="bg-white rounded-lg p-3 mb-3 max-h-60 overflow-y-auto space-y-2" id="event-chat-msgs-${e.id}">
                                    ${!e.chat||e.chat.length===0?`<p class="text-gray-400 text-sm text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>`:
                                    e.chat.map(m=>{
                                        const isMe=m.uid===currentUser.uid;
                                        return`<div class="flex ${isMe?'justify-end':'justify-start'}">
                                            <div class="max-w-[75%] ${isMe?'bg-blue-100':'bg-gray-100'} rounded-lg px-3 py-2">
                                                <p class="text-xs font-semibold ${isMe?'text-blue-700':'text-gray-700'} mb-1">${m.user}</p>
                                                ${m.image?`<img src="${m.image}" class="rounded-lg max-w-full mb-1" style="max-height:200px">`:''}
                                                ${m.msg?`<p class="text-sm text-gray-800">${m.msg}</p>`:''}
                                                <p class="text-xs text-gray-400 mt-1">${m.time}</p>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="sendEventImage('school',${e.id})" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">ğŸ“·</button>
                                    <input id="event-chat-${e.id}" onkeydown="eventChatKeyDown(event,'school',${e.id})" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-blue-500 text-sm">
                                    <button onclick="sendEventChat('school',${e.id})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold text-sm">Ø¥Ø±Ø³Ø§Ù„</button>
                                </div>
                            </div>
                            
                            <!-- Rating Section -->
                            <div class="border-t border-gray-100 p-4 bg-gray-50">
                                <h4 class="font-semibold text-gray-800 mb-2 text-right">â­ Ù‚ÙŠÙ‘Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</h4>
                                <div class="flex justify-center gap-2">
                                    ${[1,2,3,4,5].map(s=>`<button onclick="rateEvent('school',${e.id},${s})" class="text-3xl hover:scale-110 transition-transform" title="${s} Ù†Ø¬ÙˆÙ…">${s<=userRating?'â­':'â˜†'}</button>`).join('')}
                                </div>
                                ${userRating>0?`<p class="text-xs text-center text-gray-500 mt-2">ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${userRating} Ù†Ø¬ÙˆÙ…</p>`:''}
                            </div>
                        `:''}
                    </div>`;
                }).join('')}
            </div>
        `:''}
    </div></div>`;
}

// ---------- SUBJECTS ----------
function renderSubjectsPage(){
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-5 text-right slide-up">ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${subjects.map((s,i)=>{const p=getSubjectProgress(s.id);return`<div onclick="selectedSubject=${s.id};render()" class="slide-up bg-white rounded-2xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all cursor-pointer overflow-hidden" style="animation-delay:${i*.06}s"><div class="bg-gradient-to-br ${s.color} p-5 text-center"><span class="text-4xl">${s.icon}</span><h3 class="text-lg font-bold text-white mt-1">${s.name}</h3></div><div class="p-3"><div class="flex justify-between text-xs text-gray-500 mb-1"><span>${p}%</span><span>Ø§Ù„ØªÙ‚Ø¯Ù…</span></div><div class="progress-track h-2"><div class="progress-fill" style="width:${p}%"></div></div></div></div>`;}).join('')}
        </div>
    </div></div>`;
}

function renderSubjectDetail(){
    const sub=subjects.find(s=>s.id===selectedSubject); if(!sub)return'';
    const sections=[{key:'lessons',title:'Ø§Ù„Ø¯Ø±ÙˆØ³',icon:'ğŸ“–'},{key:'units',title:'Ø§Ù„ÙˆØ­Ø¯Ø§Øª',icon:'ğŸ“‘'},{key:'assignments',title:'Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª',icon:'âœï¸'},{key:'projects',title:'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',icon:'ğŸ—ï¸'},{key:'references',title:'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª',icon:'ğŸ”–'},{key:'exams',title:'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª',icon:'ğŸ“'},{key:'links',title:'Ø§Ù„Ø±ÙˆØ§Ø¨Ø·',icon:'ğŸ”—'},{key:'videos',title:'Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª',icon:'ğŸ¬'},{key:'images',title:'Ø§Ù„ØµÙˆØ±',icon:'ğŸ–¼ï¸'},{key:'files',title:'Ø§Ù„Ù…Ù„ÙØ§Øª',icon:'ğŸ“'}];
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-6xl mx-auto">
        <button onclick="selectedSubject=null;render()" class="mb-3 text-sm font-semibold text-gray-500 hover:text-gray-800">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <div class="bg-gradient-to-br ${sub.color} rounded-2xl p-6 text-white text-center shadow-xl mb-5 slide-up"><span class="text-6xl">${sub.icon}</span><h1 class="text-3xl font-bold mt-1">${sub.name}</h1></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${sections.map((sec,i)=>`<div class="bg-white rounded-2xl shadow-md p-4 slide-up" style="animation-delay:${i*.04}s">
                <div class="flex items-center justify-between mb-2"><span class="text-lg">${sec.icon}</span><h3 class="font-bold text-gray-800 text-right text-sm">${sec.title}</h3></div>
                <div class="space-y-1.5 mb-2">${sub.content[sec.key].length===0?'<p class="text-gray-400 text-xs text-right italic">Ù„Ø§ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯</p>':sub.content[sec.key].map(item=>`<div class="bg-gray-50 border border-gray-200 rounded-lg p-2.5"><div class="flex justify-between items-start gap-1.5"><div class="flex-1"><p class="font-semibold text-gray-800 text-right text-xs">${item.title}</p>${item.description?`<p class="text-gray-500 text-xs text-right">${item.description}</p>`:''}</div>${isAdminOrFounder()?`<div class="flex gap-1"><button onclick="editContent(${sub.id},'${sec.key}',${item.id})" class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-xs">âœï¸</button><button onclick="deleteContent(${sub.id},'${sec.key}',${item.id})" class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-xs">ğŸ—‘ï¸</button></div>`:''}</div></div>`).join('')}</div>
                ${isAdminOrFounder()?`<button onclick="showAddForm('${sec.key}',${sub.id})" class="w-full text-white py-1.5 rounded-lg text-xs font-bold mt-1" style="background:linear-gradient(135deg,#006C35,#00A352)">+ Ø¥Ø¶Ø§ÙØ©</button>`:''}</div>`).join('')}
        </div>
    </div></div>`;
}

// ---------- CHAT ----------
function renderChatPage(){
    if(chatPartner){
        const key=chatKey(currentUser.uid,chatPartner.uid);
        const msgs=chatMessages[key]||[];
        return `<div class="flex-1 flex flex-col" style="min-height:0;background:#efeae2">
            <!-- WhatsApp-style header -->
            <div class="px-4 py-3 flex items-center gap-3 shadow-md" style="background:#075E54">
                <button onclick="chatPartner=null;render()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-lg flex-shrink-0">
                    ${chatPartner.username.charAt(0)}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-white truncate">${chatPartner.username}</p>
                    <p class="text-xs text-green-200">Ù…ØªØµÙ„</p>
                </div>
                <button class="text-white p-2 hover:bg-white/20 rounded-full">â‹®</button>
            </div>
            
            <!-- Messages area with WhatsApp pattern -->
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="chat-msgs" style="background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxwYXRoIGQ9Ik0yMCw0MCBMNDAsNjAgTDYwLDQwIiBzdHJva2U9IiNkOWQ5ZDkiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIgb3BhY2l0eT0iMC4xIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIi8+PC9zdmc+');background-color:#efeae2">
                ${msgs.length===0?`<div class="text-center py-16">
                    <div class="bg-white/60 rounded-lg p-4 inline-block">
                        <p class="text-gray-600 text-sm">ğŸ”’ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„ØªØ´ÙÙŠØ± Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†</p>
                    </div>
                </div>`:msgs.map((m,i)=>{
                    const isMe=m.from===currentUser.uid;
                    const reactions=(m.reactions||[]).map(r=>`${r.emoji}`).join(' ');
                    const showTime=i===0||msgs[i-1]?.time!==m.time;
                    return`${showTime?`<div class="text-center my-2"><span class="bg-white/80 text-gray-600 text-xs px-3 py-1 rounded-full shadow-sm">${m.time}</span></div>`:''}
                    <div class="flex ${isMe?'justify-end':'justify-start'} msg-in group">
                        <div class="max-w-[75%] relative">
                            <div class="rounded-lg px-3 py-2 shadow-md relative ${isMe?'bg-green-100 rounded-br-none':'bg-white rounded-bl-none'}" style="position:relative">
                                ${isMe?`<div class="absolute -left-2 bottom-0 hidden group-hover:flex flex-col gap-1 bg-white rounded-lg shadow-lg p-1 z-10">
                                    <button onclick="editChatMsg(${m.id})" class="hover:bg-gray-100 p-1.5 rounded text-xs whitespace-nowrap flex items-center gap-1" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                        ØªØ¹Ø¯ÙŠÙ„
                                    </button>
                                    <button onclick="deleteChatMsg(${m.id})" class="hover:bg-gray-100 p-1.5 rounded text-xs whitespace-nowrap flex items-center gap-1 text-red-600" title="Ø­Ø°Ù">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Ø­Ø°Ù
                                    </button>
                                </div>`:''}
                                <button onclick="addReaction(${m.id})" class="absolute ${isMe?'-left-8':'right-2'} top-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-full p-1 shadow-md hover:bg-gray-50" title="ØªÙØ§Ø¹Ù„">
                                    <span class="text-sm">â¤ï¸</span>
                                </button>
                                <p class="text-sm text-gray-800 break-words" style="word-wrap:break-word;white-space:pre-wrap">${m.text}</p>
                                <div class="flex items-center justify-end gap-1 mt-1">
                                    ${m.edited?'<span class="text-xs text-gray-500">Ù…Ø¹Ø¯Ù‘Ù„Ø©</span>':''}
                                    <span class="text-xs ${isMe?'text-gray-600':'text-gray-400'}">${m.time.split(':').slice(0,2).join(':')}</span>
                                    ${isMe?`<svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>`:''}
                                </div>
                            </div>
                            ${reactions?`<div class="flex gap-1 mt-1 ${isMe?'justify-end':'justify-start'}">${reactions.split(' ').map(e=>`<span class="bg-white rounded-full px-2 py-0.5 text-xs shadow-sm">${e}</span>`).join('')}</div>`:''}
                        </div>
                    </div>`;
                }).join('')}
            </div>
            
            <!-- WhatsApp-style input -->
            <div class="p-2 bg-gray-100 flex items-center gap-2 flex-shrink-0">
                <button class="text-gray-600 hover:text-gray-800 p-2 hover:bg-gray-200 rounded-full transition-all">ğŸ˜Š</button>
                <button class="text-gray-600 hover:text-gray-800 p-2 hover:bg-gray-200 rounded-full transition-all">ğŸ“</button>
                <input id="chat-input" type="text" onkeydown="chatKeyDown(event)" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©" class="flex-1 px-4 py-2.5 rounded-full border-none focus:outline-none text-sm bg-white" style="box-shadow:0 1px 2px rgba(0,0,0,0.1)">
                <button onclick="sendChatMsg()" class="p-3 rounded-full text-white hover:opacity-90 transition-all" style="background:#25D366">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
            </div>
        </div>`;
    }
    
    // Chat list (WhatsApp style)
    const allUsers=users.filter(u=>u.uid!==currentUser.uid&&u.approved);
    const filtered=searchQuery?allUsers.filter(u=>u.uid.toUpperCase().includes(searchQuery.toUpperCase())||u.username.includes(searchQuery)):[];
    const recentKeys=Object.keys(chatMessages).filter(k=>k.includes(currentUser.uid)&&chatMessages[k].length>0);
    const recentPartners=recentKeys.map(k=>{const otherUid=k.split('_').find(id=>id!==currentUser.uid);return users.find(u=>u.uid===otherUid);}).filter(Boolean);

    return `<div class="flex-1 flex flex-col" style="min-height:0;background:#fff">
        <!-- WhatsApp header -->
        <div class="px-4 py-4 flex items-center justify-between shadow-sm" style="background:#075E54">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-lg">
                    ${currentUser.username.charAt(0)}
                </div>
                <h1 class="text-xl font-semibold text-white">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h1>
            </div>
            <button class="text-white p-2 hover:bg-white/20 rounded-full">â‹®</button>
        </div>
        
        <!-- Search bar -->
        <div class="px-3 py-2 bg-gray-100">
            <div class="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input id="chat-search" type="text" oninput="searchUser()" placeholder="Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©" class="flex-1 outline-none text-sm">
            </div>
        </div>
        
        <!-- Chat list -->
        <div class="flex-1 overflow-y-auto">
            ${searchQuery&&filtered.length>0?`
                <div class="px-3 py-2 bg-gray-100 text-xs text-gray-600 text-right">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
                ${filtered.map(u=>`
                <div onclick="startChat('${u.uid}')" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-lg flex-shrink-0">
                        ${u.username.charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <p class="font-semibold text-gray-800 truncate">${u.username}</p>
                        </div>
                        <p class="text-xs text-gray-500 truncate">ID: ${u.uid}</p>
                    </div>
                </div>
                `).join('')}
            `:searchQuery&&filtered.length===0?`
                <div class="text-center py-16">
                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
                </div>
            `:recentPartners.length>0?recentPartners.map(u=>{
                const key=chatKey(currentUser.uid,u.uid);
                const lastMsg=chatMessages[key].slice(-1)[0];
                const unread=0; // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
                return`
                <div onclick="startChat('${u.uid}')" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-lg flex-shrink-0">
                        ${u.username.charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <p class="font-semibold text-gray-800 truncate">${u.username}</p>
                            <span class="text-xs text-gray-400 flex-shrink-0 mr-2">${lastMsg?.time.split(':').slice(0,2).join(':')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-500 truncate">${lastMsg?lastMsg.text.slice(0,35)+'...':'Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø©'}</p>
                            ${unread>0?`<span class="bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center flex-shrink-0">${unread}</span>`:''}
                        </div>
                    </div>
                </div>`;
            }).join(''):`
                <div class="text-center py-16">
                    <svg class="w-24 h-24 mx-auto text-gray-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <p class="text-gray-500 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p>
                    <p class="text-gray-400 text-sm">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø®Øµ Ø¨Ø§Ù„Ù€ ID Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
                </div>
            `}
        </div>
    </div>`;
}

// ---------- PROFILE ----------
function renderProfilePage(){
    if(!currentUser)return'<div class="flex-1 p-8"><p class="text-red-600">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p></div>';
    const roleLabel=currentUser.role==='founder'?'ğŸ‘‘ Ù…Ø¤Ø³Ø³':currentUser.role==='admin'?'ğŸ›¡ï¸ Ù…Ø´Ø±Ù':'ğŸ‘¨â€ğŸ“ Ø·Ø§Ù„Ø¨';
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-lg mx-auto space-y-5">
        <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ</h1>
        <div class="rounded-2xl p-6 text-white shadow-xl slide-up text-center" style="background:linear-gradient(135deg,#004d26,#00A352)">
            <div class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mx-auto mb-3"><span class="text-4xl">ğŸ‘¤</span></div>
            <h2 class="text-2xl font-bold">${currentUser.username}</h2>
            <p class="text-green-200 text-sm">${roleLabel}</p>
            <!-- UID copyable -->
            <div class="mt-3 inline-flex items-center gap-2 bg-white/10 rounded-full px-4 py-1.5">
                <button onclick="navigator.clipboard.writeText('${currentUser.uid}').then(()=>alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù€ ID'))" class="text-xs text-green-200 hover:text-white">ğŸ“‹ Ù†Ø³Ø®</button>
                <span class="text-sm font-bold text-white">ID: ${currentUser.uid}</span>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.1s">
            <h3 class="font-bold text-gray-800 mb-3 text-right">ğŸ“ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
            ${[['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',currentUser.username],['Ø§Ù„Ù€ ID',currentUser.uid],['Ø§Ù„Ø±ØªØ¨Ø©',roleLabel],['Ø§Ù„Ø­Ø§Ù„Ø©','âœ“ Ù…ÙØ¹Ù‘Ù„']].map(([l,v])=>`<div class="flex justify-between py-2 border-b border-gray-100"><span class="font-semibold text-gray-700 text-sm">${v}</span><span class="text-gray-500 text-sm">${l}</span></div>`).join('')}
        </div>
    </div></div>`;
}

// ---------- ADMIN PANEL ----------
function renderAdminPanel(){
    return `<div class="flex-1 p-6 overflow-auto"><div class="max-w-3xl mx-auto space-y-5">
        <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h1>
        <!-- pending -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up">
            <h3 class="font-bold text-gray-800 mb-3 text-right">â³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (${pendingUsers.length})</h3>
            ${pendingUsers.length===0?'<p class="text-gray-400 text-center py-3 text-sm">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª</p>':pendingUsers.map(u=>`<div class="flex items-center justify-between bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2"><div class="flex gap-2"><button onclick="approveUser(${u.id})" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">âœ“ Ù‚Ø¨ÙˆÙ„</button><button onclick="rejectUser(${u.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">âœ•</button></div><p class="font-bold text-gray-800 text-sm">${u.username}</p></div>`).join('')}
        </div>
        <!-- accounts -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.08s">
            <h3 class="font-bold text-gray-800 mb-3 text-right">ğŸ‘¥ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (${users.filter(u=>u.role==='student').length} Ø·Ø§Ù„Ø¨)</h3>
            ${users.filter(u=>u.role==='student').length===0?'<p class="text-gray-400 text-center py-3 text-sm">Ù„Ø§ Ø·Ù„Ø§Ø¨</p>':users.filter(u=>u.role==='student').map(u=>`<div class="border border-gray-200 rounded-lg p-3 mb-2"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-400">ID: ${u.uid}</span><p class="font-bold text-gray-800 text-sm">${u.username}</p></div><div class="grid grid-cols-2 gap-1.5">${[['ğŸ‘ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',`showUserPassword(${u.id})`,'blue'],['âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…',`editUsername(${u.id})`,'indigo'],['ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',`editPassword(${u.id})`,'purple'],['ğŸ—‘ï¸ Ø­Ø°Ù',`deleteUser(${u.id})`,'red']].map(([l,fn,c])=>`<button onclick="${fn}" class="bg-${c}-100 text-${c}-700 py-1 rounded text-xs font-semibold">${l}</button>`).join('')}</div></div>`).join('')}
        </div>
        <!-- chat monitoring -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.12s">
            <h3 class="font-bold text-gray-800 mb-3 text-right">ğŸ‘ï¸ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
            ${Object.keys(chatMessages).filter(k=>chatMessages[k].length>0).length===0?'<p class="text-gray-400 text-center py-3 text-sm">Ù„Ø§ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</p>':
            Object.keys(chatMessages).filter(k=>chatMessages[k].length>0).map(key=>{
                const uids=key.split('_');
                const u1=users.find(u=>u.uid===uids[0]),u2=users.find(u=>u.uid===uids[1]);
                if(!u1||!u2)return'';
                const msgs=chatMessages[key];
                return`<div class="border border-gray-200 rounded-lg p-3 mb-2 cursor-pointer hover:bg-gray-50" onclick="monitorChat('${key}')">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${msgs.length} Ø±Ø³Ø§Ù„Ø©</span>
                        <p class="font-semibold text-gray-800 text-sm text-right">${u1.username} â†” ${u2.username}</p>
                    </div>
                    <p class="text-xs text-gray-400 text-right mt-1">${msgs.slice(-1)[0].text.slice(0,40)}...</p>
                </div>`;
            }).join('')}
        </div>
        <!-- announcements -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.16s">
            <div class="flex items-center justify-between mb-3"><button onclick="addAnnouncement()" class="text-white px-3 py-1 rounded text-xs font-bold" style="background:linear-gradient(135deg,#006C35,#00A352)">+ Ø¥Ø¹Ù„Ø§Ù†</button><h3 class="font-bold text-gray-800">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3></div>
            ${announcements.map(a=>`<div class="flex items-start justify-between bg-gray-50 border border-gray-100 rounded-lg p-2.5 mb-1.5"><button onclick="deleteAnnouncement(${a.id})" class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-xs">Ø­Ø°Ù</button><p class="text-gray-700 text-xs text-right flex-1 ml-2">${a.text}</p></div>`).join('')}
        </div>
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.2s">
            <h3 class="font-bold text-gray-800 mb-2 text-right">ğŸ“š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
            <button onclick="currentView='subjects';render()" class="w-full text-white py-2 rounded-lg text-sm font-bold" style="background:linear-gradient(135deg,#006C35,#00A352)">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…ÙˆØ§Ø¯</button>
        </div>
    </div></div>`;
}

// Monitor a specific chat (admin view)
let monitorKey=null;
function monitorChat(key){monitorKey=key;render();}
function renderMonitorChat(){
    const uids=monitorKey.split('_');
    const u1=users.find(u=>u.uid===uids[0]),u2=users.find(u=>u.uid===uids[1]);
    const msgs=chatMessages[monitorKey]||[];
    return`<div class="flex-1 flex flex-col" style="min-height:0">
        <div class="p-3 border-b bg-white flex items-center justify-between flex-shrink-0">
            <button onclick="monitorKey=null;currentView='admin';render()" class="text-sm text-gray-500">â† Ø±Ø¬ÙˆØ¹</button>
            <div class="text-right"><p class="font-bold text-gray-800 text-sm">${u1?.username||'ØŸ'} â†” ${u2?.username||'ØŸ'}</p><p class="text-xs text-red-500">ğŸ‘ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</p></div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
            ${msgs.length===0?'<p class="text-gray-400 text-center py-8 text-sm">Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„</p>':msgs.map(m=>{const sender=users.find(u=>u.uid===m.from);const isFirst=m.from===uids[0];return`<div class="flex ${isFirst?'justify-start':'justify-end'} msg-in"><div class="max-w-[70%] rounded-2xl px-3 py-2 shadow-sm ${isFirst?'bg-blue-50 border border-blue-200 rounded-tl-none':'bg-orange-50 border border-orange-200 rounded-tr-none'}"><div class="flex justify-between items-center mb-0.5"><span class="text-xs text-gray-400">${m.time}</span><span class="text-xs font-bold ${isFirst?'text-blue-600':'text-orange-600'}">${sender?.username||'ØŸ'}</span></div><p class="text-right text-sm text-gray-800 whitespace-pre-wrap">${m.text}</p></div></div>`;}).join('')}
        </div>
    </div>`;
}

// ---------- FOUNDER PANEL ----------
function renderFounderPanel(){
    const admins=users.filter(u=>u.role==='admin');
    const founders=users.filter(u=>u.role==='founder');
    return`<div class="flex-1 p-6 overflow-auto"><div class="max-w-3xl mx-auto space-y-5">
        <h1 class="text-2xl font-bold text-gray-800 text-right slide-up">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ø³Ø³</h1>
        <!-- add admin -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up">
            <div class="flex items-center justify-between mb-3"><button onclick="founderAddAdmin()" class="text-white px-4 py-2 rounded-lg text-sm font-bold shadow" style="background:linear-gradient(135deg,#006C35,#00A352)">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯</button><h3 class="font-bold text-gray-800">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h3></div>
            ${admins.length===0?'<p class="text-gray-400 text-center py-3 text-sm">Ù„Ø§ Ù…Ø´Ø±ÙÙŠÙ†</p>':admins.map(u=>`<div class="flex items-center justify-between border border-gray-200 rounded-lg p-3 mb-2">
                <div class="flex gap-2">
                    <button onclick="changeRole(${u.id})" class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-bold">ğŸ‘‘ ØºÙŠÙ‘Ø± Ø§Ù„Ø±ØªØ¨Ø©</button>
                    <button onclick="editPassword(${u.id})" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">ğŸ”‘</button>
                    <button onclick="deleteUser(${u.id})" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button>
                </div>
                <div class="text-right"><p class="font-bold text-gray-800 text-sm">${u.username}</p><p class="text-xs text-gray-400">ID: ${u.uid} â€¢ Ù…Ø´Ø±Ù</p></div>
            </div>`).join('')}
        </div>
        <!-- all users + role control -->
        <div class="bg-white rounded-2xl shadow-md p-5 slide-up" style="animation-delay:.1s">
            <h3 class="font-bold text-gray-800 mb-3 text-right">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (${users.length})</h3>
            ${users.map(u=>{if(u.id===currentUser.id)return'';const badge=u.role==='founder'?'bg-amber-100 text-amber-700':u.role==='admin'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700';const rl=u.role==='founder'?'Ù…Ø¤Ø³Ø³':u.role==='admin'?'Ù…Ø´Ø±Ù':'Ø·Ø§Ù„Ø¨';return`<div class="flex items-center justify-between border border-gray-200 rounded-lg p-3 mb-2">
                <div class="flex gap-1.5">
                    <button onclick="changeRole(${u.id})" class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold">ğŸ‘‘ Ø±ØªØ¨Ø©</button>
                    <button onclick="showUserPassword(${u.id})" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs">ğŸ‘ï¸</button>
                    <button onclick="deleteUser(${u.id})" class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs">ğŸ—‘ï¸</button>
                </div>
                <div class="text-right"><div class="flex items-center gap-2"><span class="text-xs ${badge} px-1.5 py-0.5 rounded-full">${rl}</span><p class="font-bold text-gray-800 text-sm">${u.username}</p></div><p class="text-xs text-gray-400">ID: ${u.uid}</p></div>
            </div>`;}).join('')}
        </div>
    </div></div>`;
}

// ===================== MAIN RENDER =====================
function render(){
    const app=document.getElementById('app');
    if(!currentUser||currentView==='login'){app.innerHTML=renderLoginPage();return;}

    let content='';
    // monitor chat override
    if(monitorKey&&(currentUser.role==='admin'||currentUser.role==='founder')){content=renderMonitorChat();}
    else if(selectedSubject) content=renderSubjectDetail();
    else if(currentView==='home')      content=renderHomePage();
    else if(currentView==='subjects')  content=renderSubjectsPage();
    else if(currentView==='timetable') content=renderTimetablePage();
    else if(currentView==='ai')        content=renderAiPage();
    else if(currentView==='events')    content=renderEventsPage();
    else if(currentView==='news')      content=renderNewsPage();
    else if(currentView==='chat')      content=renderChatPage();
    else if(currentView==='profile')   content=renderProfilePage();
    else if(currentView==='admin')     content=renderAdminPanel();
    else if(currentView==='founder')   content=renderFounderPanel();
    else                               content=renderHomePage();

    app.innerHTML=`<div class="flex" style="min-height:100vh">${renderSidebar()}${content}</div>`;

    if(currentView==='ai'){const c=document.getElementById('ai-messages-container');if(c)c.scrollTop=c.scrollHeight;}
    if(currentView==='chat'&&chatPartner){const c=document.getElementById('chat-msgs');if(c)c.scrollTop=c.scrollHeight;}
    if(currentView==='chat'&&!chatPartner){const inp=document.getElementById('chat-search');if(inp)inp.focus();}
}

loadData();
render();

// Handle window resize for responsive behavior
window.addEventListener('resize', ()=>{
    const isMobile = window.innerWidth <= 768;
    const shouldBeClosed = isMobile;
    if(sidebarOpen === shouldBeClosed) {
        sidebarOpen = !shouldBeClosed;
        render();
    }
});
</script>
</body>
</html>
